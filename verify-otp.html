<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Verify Phone | Shamor Rides</title>

<style>
:root {
  --bg: #070b18;
  --glass: rgba(255,255,255,0.08);
  --glass-border: rgba(255,255,255,0.18);
  --primary: #7c5cff;
  --primary-dark: #5a3cff;
  --text: #eaeaff;
  --muted: #aab0ff;
}

* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, sans-serif;
}

body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(-45deg, #1a1f4a, #070b18, #2a1f6a, #070b18);
  background-size: 400% 400%;
  animation: bgMove 18s ease infinite;
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1.5rem;
}

@keyframes bgMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.card {
  width: 100%;
  max-width: 420px;
  background: var(--glass);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 26px;
  padding: 2.8rem 2.2rem;
  text-align: center;
  box-shadow: 0 30px 80px rgba(0,0,0,0.45);
  transition: transform .3s ease, box-shadow .3s ease;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 40px 90px rgba(0,0,0,0.6);
}

h2 {
  margin: 0 0 .5rem;
}

p {
  color: var(--muted);
  font-size: .95rem;
}

.otp-box {
  display: flex;
  justify-content: center;
  gap: .6rem;
  margin: 1.8rem 0;
}

.otp-box input {
  width: 46px;
  height: 56px;
  font-size: 1.4rem;
  text-align: center;
  border-radius: 14px;
  border: 1px solid transparent;
  background: rgba(255,255,255,0.12);
  color: var(--text);
  outline: none;
  transition: all .25s ease;
}

.otp-box input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(124,92,255,.35);
}

button {
  width: 100%;
  padding: 1rem;
  border-radius: 999px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  background: linear-gradient(135deg,var(--primary),var(--primary-dark));
  color: white;
  transition: transform .2s ease, box-shadow .2s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 30px rgba(124,92,255,.5);
}

button:active {
  transform: scale(.97);
}

.resend {
  margin-top: 1.2rem;
  font-size: .9rem;
}

.resend a {
  color: var(--primary);
  cursor: pointer;
  text-decoration: none;
}

.resend span {
  color: var(--muted);
}
</style>
</head>

<body>

<div class="card">
  <h2>üîê Verify Phone</h2>
  <p>Enter the 6-digit code sent to your phone</p>

  <div class="otp-box" id="otpBox">
    <input maxlength="1" />
    <input maxlength="1" />
    <input maxlength="1" />
    <input maxlength="1" />
    <input maxlength="1" />
    <input maxlength="1" />
  </div>

  <button onclick="verifyOTP()">Verify</button>

  <div class="resend">
    <span id="timerText">Didn‚Äôt receive code?</span>
    <a id="resendLink" onclick="resendOTP()">Resend</a>
  </div>
</div>

<script type="module">
import { API_BASE } from "./js/config.js";

const phone = localStorage.getItem("pending_phone");
if (!phone) location.href = "auth.html";

const inputs = [...document.querySelectorAll(".otp-box input")];
const resendLink = document.getElementById("resendLink");
const timerText = document.getElementById("timerText");

let cooldown = 60;
let timer;

/* =========================
   OTP INPUT LOGIC
========================= */
inputs.forEach((input, idx) => {
  input.addEventListener("input", e => {
    e.target.value = e.target.value.replace(/\D/g, "");
    if (e.target.value && inputs[idx + 1]) {
      inputs[idx + 1].focus();
    }
    autoSubmit();
  });

  input.addEventListener("keydown", e => {
    if (e.key === "Backspace" && !e.target.value && inputs[idx - 1]) {
      inputs[idx - 1].focus();
    }
  });

  input.addEventListener("paste", e => {
    const data = e.clipboardData.getData("text").replace(/\D/g, "").slice(0,6);
    data.split("").forEach((d, i) => inputs[i].value = d);
    autoSubmit();
  });
});

inputs[0].focus();

/* =========================
   VERIFY OTP
========================= */
async function verifyOTP() {
  const code = inputs.map(i => i.value).join("");
  if (code.length !== 6) {
    alert("Enter complete 6-digit code");
    return;
  }

  const res = await fetch(`${API_BASE}/auth/verify-phone`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone, code }),
  });

  const data = await res.json();
  if (!res.ok) {
    alert(data.detail || "Verification failed");
    return;
  }

  localStorage.removeItem("pending_phone");
  alert("Phone verified! You can now login.");
  location.href = "auth.html";
}

function autoSubmit() {
  if (inputs.every(i => i.value)) verifyOTP();
}

/* =========================
   RESEND OTP + TIMER
========================= */
function startTimer() {
  resendLink.style.pointerEvents = "none";
  resendLink.style.opacity = "0.5";

  timerText.textContent = `Resend available in ${cooldown}s`;

  timer = setInterval(() => {
    cooldown--;
    timerText.textContent = `Resend available in ${cooldown}s`;
    if (cooldown <= 0) {
      clearInterval(timer);
      timerText.textContent = "Didn‚Äôt receive code?";
      resendLink.style.pointerEvents = "auto";
      resendLink.style.opacity = "1";
      cooldown = 60;
    }
  }, 1000);
}

async function resendOTP() {
  inputs.forEach(i => i.value = "");
  inputs[0].focus();

  const res = await fetch(`${API_BASE}/auth/resend-otp`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone }),
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.detail || "Failed to resend OTP");
    return;
  }

  alert("New OTP sent to your phone");
  startTimer();
}

</script>

</body>
</html>
